
# Day 11: 指令级并行（ILP）

## 学习目标

- 理解什么是 **指令级并行（ILP, Instruction-Level Parallelism）**
- 了解 **超标量处理器** 和 **乱序执行（Out-of-Order Execution）**
- 理解 **指令窗口** 和 **Tomasulo 算法** 的基本思想
- 绘制指令调度流程的示意图，帮助建立直观理解

---

## 1. 什么是 ILP（指令级并行）

指令级并行指的是：**在一个时钟周期内，能够同时执行多条指令的能力**。现代 CPU 设计中会通过各种方式提高 ILP，从而提升指令吞吐量。

> **关键目标：在不改变程序语义的前提下，提高执行效率。**

---

## 2. 超标量（Superscalar）

超标量处理器通过在 CPU 内部集成多个执行单元，使得**每个周期能发射多条指令**。

### 特点：

- **多个取指（Fetch）单元**
- **多个发射（Dispatch）单元**
- **多个执行单元（ALU、FPU等）**
- 自动处理指令依赖，提升并行度

### 举例：

假设某 CPU 是 2 发射超标量：
- Cycle 1: 同时发射 `ADD R1, R2, R3` 和 `MUL R4, R5, R6`
- Cycle 2: 同时发射 `SUB R7, R8, R9` 和 `DIV R10, R11, R12`

---

## 3. 乱序执行（Out-of-Order Execution）

为了减少流水线因数据依赖导致的停顿，**CPU 可以不按程序原始顺序执行指令**，只要结果和顺序正确就可以。

### 简单例子：

```asm
1: LD R1, 0(R2)      ; 依赖数据
2: ADD R3, R4, R5    ; 无依赖
```

即使第1条指令还没完成，只要第2条指令不冲突，CPU可以先执行它。

---

## 4. 指令窗口（Instruction Window）

指令窗口是一个**暂存区**，里面保存着等待执行的指令。调度器从中选择可以立即执行的指令发射出去。

越大的指令窗口，就越有可能找到可以并行执行的指令。

---

## 5. Tomasulo 算法简介

Tomasulo 算法是一个经典的**动态调度算法**，用于乱序执行。它通过以下机制解决数据相关问题：

### 核心组件：

- **保留站（Reservation Station）**：暂存待执行指令
- **通用寄存器重命名**：解决写后读、写后写冲突（WAW、RAW）
- **广播机制（CDB）**：写回结果时广播给所有等待的数据源

### 数据前递示意：

```
           +------------+
   发射 -->| 保留站 RS1 |
           +------------+
                ↓ 等待数据
           +------------+
           | 执行单元  |
           +------------+
                ↓
            写回广播(CDB)
```

---

## 6. 图示：指令调度流程

（此处请绘制如下结构图，或使用文字表示）

```
指令取值 → 放入保留站 → 检查依赖 → 执行单元运行 → 写回结果（CDB）
```

---

## ✅ 小结

- ILP 是提升性能的重要手段
- 超标量通过多个执行单元实现并发
- 乱序执行和 Tomasulo 算法让 CPU 更智能地调度指令

---

## 📌 建议练习

1. 画出包含 4 条指令的乱序执行流程图
2. 解释 Tomasulo 算法中保留站的作用
3. 举例说明数据冒险的前递是如何解决的

---

祝你学得开心，继续加油！🚀
