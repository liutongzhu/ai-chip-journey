# Day 10：控制冒险与解决策略

## 🎯 学习目标

- 理解控制冒险（Control Hazard）是什么
- 学习两种常见的解决策略：**分支预测** 和 **延迟槽**
- 对比静态分支预测与动态分支预测的优劣
- 能画出简单的控制冒险与分支预测示意图

---

## 📌 一、什么是控制冒险？

当一条指令依赖于跳转或分支指令的执行结果（例如 `if/else`），而处理器还未决定跳转是否发生时，就会产生 **控制冒险**。

### 📍 举例说明

```asm
BEQ R1, R2, Label   ; 如果R1==R2，则跳转到Label
ADD R3, R4, R5      ; 如果跳转，这条指令就不该执行
```

---

## ⚙️ 二、解决策略一：分支预测（Branch Prediction）

### 1. 静态预测（Static Prediction）

静态预测在编译时或硬件设计时固定策略：

- **总是跳转**
- **总是不跳转**
- **根据方向**：比如向前跳转预测为跳转，向后跳转预测为不跳转（适用于循环）

#### ✅ 优点

- 实现简单
- 无需额外硬件

#### ❌ 缺点

- 不适应程序运行过程中的实际行为

---

### 2. 动态预测（Dynamic Prediction）

动态预测使用运行时的历史记录预测分支结果，使用硬件维护预测表，如：

- **1-bit predictor**：记录上次跳转是否发生
- **2-bit saturating counter**：提高准确率，避免短期波动影响预测
- **分支目标缓冲区（BTB）**：缓存跳转目标地址

#### ✅ 优点

- 预测准确率高
- 能适应运行时的行为模式

#### ❌ 缺点

- 实现复杂
- 占用更多硬件资源

---

## 📊 三、解决策略二：延迟槽（Delay Slot）

### 定义

把跳转指令的下一条指令（即延迟槽）总是执行，不管是否跳转。

```asm
BEQ R1, R2, Label
ADD R3, R4, R5    ; 延迟槽，始终执行
```

编译器或程序员手动将不会影响结果的指令放入延迟槽中，提高流水线效率。

---

## 🧠 四、思维导图/示意图（手绘风格）

```
分支预测分类：
┌──────────────┐
│ 分支预测      │
├──────────────┤
│ 静态预测      │
│   ├─ 总是跳转  │
│   └─ 总是不跳转│
│ 动态预测      │
│   ├─ 1-bit预测 │
│   └─ 2-bit预测 │
└──────────────┘
```

---

## 🧩 五、新手建议练习

1. 找一个 C 程序中的 if-else 判断，写出对应的汇编伪代码
2. 思考编译器如何用延迟槽重排代码
3. 画出静态 vs 动态预测的准确率变化曲线（可以模拟或查资料）

---

## ✅ 今日总结

| 项目       | 静态预测     | 动态预测       |
|------------|--------------|----------------|
| 实现复杂度 | 低           | 高             |
| 准确率     | 低～中       | 高             |
| 硬件开销   | 几乎无       | 较高           |
| 是否自适应 | 否           | 是             |

掌握控制冒险的处理机制是理解高级流水线优化的关键一步！

---

（完）
